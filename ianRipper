#!/bin/bash

###################################################################
#Nom du script	: ianRipper                                                           
#Description	: Ce script permet de ripper des DVD.                                                                                   
#Auteur       	: Yann Le Coz                                           
###################################################################

# Définition et initialisation des variables
DEV='/dev/dvd'
name="$(lsdvd $DEV 2>/dev/null | awk 'NR==1 {print $3}' | sed 's/.*/\L&/; s/[a-z]*/\u&/g; s/_/ /g')"
titleToEncode="$(lsdvd $DEV 2>/dev/null | awk 'END{print $3}')"
audioCode='fre'
fileFormat='mp4'
audioEncoder='copy:dtshd'
audioMixing='stereo'
preset='Super HQ 1080p30 Surround'

# Vérification que les paquets requis sont installés
if ! `command -v lsdvd > /dev/null` && ! `command -v HandBrakeCLI > /dev/null`
then
	echo -e "Veuillez installer les paquets:\n  lsdvd\n  handbrake-cli"
	exit
elif ! `command -v lsdvd > /dev/null`
then
	echo -e "Veuillez installer le paquet:\n  lsdvd"
	exit
elif ! `command -v HandBrakeCLI > /dev/null`
then
	echo -e "Veuillez installer le paquet:\n  handbrake-cli"
	exit
fi

# Vérification qu'un DVD est bien inséré dans le lecteur
lsdvd $DEV > /dev/null 2>&1
if [ $? != 0 ]
then
        echo -e "\nAucune donnée trouvée. Veuillez vous assurer que vous avez inséré un DVD lisible et que votre lecteur optique fonctionne."
        exit
fi

# Attribution d'une piste audio à chaque code ISO 639-2
if [ $audioCode = 'eng' ]
then
	audio='Anglais'
elif [ $audioCode = 'spa' ]
then
	audio='Espagnol'
elif [ $audioCode = 'dut' ]
then
	audio='Allemand'
else
	audio='Français'
fi

echo -e "Titre du film:\t$name\nQualité:\t$preset\nFormat:\t\t$fileFormat\nPiste audio:\t$audio\nSon encodé:\t$audioEncoder\nMixage audio:\t$audioMixing\n"

HandBrakeCLI -i "$DEV" -o "$name"."$fileFormat" -E "$audioEncoder" -s 'none' -t "$titleToEncode" --audio-lang-list "$audioCode" --mixdown "$audioMixing" --preset "$preset" --two-pass 2>"$name".log

# On supprime le fichier de log
rm -f "$name".log

echo -e "\nRipping du DVD terminé.\n$HOME/Documents/$name.$fileFormat"
